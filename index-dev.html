<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>The Scala.js Tutorial</title>
    <link
            rel="stylesheet"
            data-name="vs/editor/editor.main"
            href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.31.0-dev.20211208/min/vs/editor/editor.main.min.css"
    />
</head>
<body>
<div>
    ID:
    <span id="peerId"></span>
</div>
<label for="remote-peer-id">Remote ID</label><input type="text" id="remote-peer-id"/>
<button onclick="connectRemotePeer()">Connect</button>
<div id="container" style="width: 800px; height: 600px; border: 1px solid grey"></div>
<script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
<script>
    const peerIdSpan = document.getElementById('peerId');
    const remoteSpan = document.getElementById('remote-peer-id');

    const peer = new Peer();
    const connections = [];
    peer.on('open', (id) => peerIdSpan.textContent = id);
    peer.on('connection', (connection) => connection.on('data', (data) => receiveRemoteUpdate(data)));

    function connectRemotePeer() {
        const remoteId = remoteSpan.value.trim();
        remoteSpan.value = '';
        if (remoteId.length === 0) return;
        const connection = peer.connect(remoteId);
        connection.on('open', () => connections.push(connection))
    }

    function publish(data) {
        connections.forEach((connection) => connection.send(data));
    }
</script>
<!-- src: https://github.com/microsoft/monaco-editor/blob/main/samples/browser-script-editor/index.html -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.31.0-dev.20211208/min/vs/loader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.31.0-dev.20211208/min/vs/editor/editor.main.nls.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.31.0-dev.20211208/min/vs/editor/editor.main.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.31.0-dev.20211208/min/vs/basic-languages/scheme/scheme.min.js"></script>
<script>
    var editor = monaco.editor.create(document.getElementById('container'), {
        language: 'scheme'
    });

    let lastSource;

    // src: https://microsoft.github.io/monaco-editor/api/interfaces/monaco.editor.ITextModel.html#onDidChangeContent
    editor.getModel().onDidChangeContent((_) => {
        setTimeout(() => {
            // src: https://stackoverflow.com/a/38092508
            const changedSource = editor.getValue();

            if(lastSource === changedSource) return;
            lastSource = changedSource;

            // src: https://stackoverflow.com/a/50093042
            const position = editor.getModel().getOffsetAt(editor.getPosition())
            // update code & query new position
            const newPosition = sourceCodeChange(position, changedSource)

            const newSource = editor.getValue();
            const textAsArr = newSource.split("");
            const skippingC = textAsArr.slice(0,newPosition);
            const lineNumber = 1 + skippingC.filter(c => c === "\n").length;
            const column = newSource.slice(0, newPosition).split("\n").slice(-1)[0].length + 1;
            const newPosObj = {column, lineNumber};

            const before = changedSource.slice(0, position).concat("|").concat(changedSource.slice(position));
            const after = newSource.slice(0, newPosition).concat("|").concat(newSource.slice(newPosition));
            console.log(`Before at ${position}\n${before}`);
            console.log(`After at ${newPosition}\n${after}`);
            console.log(newPosObj);
            editor.setPosition(newPosObj);
        }, 0)
    });

    function updateSourceCode(newSourceCode) {
        editor.setValue(newSourceCode)
    }
</script>
<!-- Include Scala.js compiled code -->
<script type="text/javascript" src="./target/scala-2.13/scala-js-tutorial-fastopt/main.js"></script>
</body>
</html>